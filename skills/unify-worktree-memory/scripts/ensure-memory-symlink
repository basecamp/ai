#!/usr/bin/env bash
#
# SessionStart hook: ensure worktree memory dirs symlink to the base repo's memory.
#
# Reads the session JSON from stdin, extracts cwd, checks if it's a git worktree,
# and creates the symlink if needed. Fast-paths (~5ms) for non-worktree sessions.
#
set -euo pipefail

CLAUDE_PROJECTS="$HOME/.claude/projects"

# Read session JSON from stdin
input=$(cat)
cwd=$(echo "$input" | jq -r '.cwd // empty')

if [[ -z "$cwd" ]]; then
  exit 0
fi

# Fast path: check if this is a git worktree
git_common_dir=$(git -C "$cwd" rev-parse --git-common-dir 2>/dev/null) || exit 0
git_dir=$(git -C "$cwd" rev-parse --git-dir 2>/dev/null) || exit 0

# Resolve to absolute paths for comparison
git_common_dir=$(cd "$cwd" && cd "$git_common_dir" && pwd)
git_dir_abs=$(cd "$cwd" && cd "$git_dir" && pwd)

# Not a worktree if git-dir and git-common-dir resolve to the same .git
if [[ "$git_common_dir" == "$git_dir_abs" ]]; then
  exit 0
fi

# This is a worktree. Resolve the base repo path.
base_repo=$(echo "$git_common_dir" | sed 's|/\.git$||')

# Encode paths the way Claude Code does: replace / and . with -
encode_path() {
  echo "$1" | sed 's|/|-|g; s|\.|-|g'
}

base_project_dir="$CLAUDE_PROJECTS/$(encode_path "$base_repo")"
base_memory="$base_project_dir/memory"

cwd_project_dir="$CLAUDE_PROJECTS/$(encode_path "$cwd")"
cwd_memory="$cwd_project_dir/memory"

# Already a symlink â€” nothing to do
if [[ -L "$cwd_memory" ]]; then
  exit 0
fi

# Ensure base memory dir exists
mkdir -p "$base_memory"

# If worktree has existing memory content, move it to base
if [[ -d "$cwd_memory" ]]; then
  # Move MEMORY.md content (append to base if both exist)
  if [[ -f "$cwd_memory/MEMORY.md" ]]; then
    if [[ -f "$base_memory/MEMORY.md" ]]; then
      {
        printf '\n## From worktree: %s\n\n' "$(basename "$cwd")"
        cat "$cwd_memory/MEMORY.md"
      } >> "$base_memory/MEMORY.md"
    else
      mv "$cwd_memory/MEMORY.md" "$base_memory/MEMORY.md"
    fi
  fi

  # Move topic files (rename on conflict to avoid data loss)
  for f in "$cwd_memory"/*; do
    [[ -e "$f" ]] || continue
    fname=$(basename "$f")
    [[ "$fname" == "MEMORY.md" ]] && continue
    if [[ -e "$base_memory/$fname" ]]; then
      wt_hint=$(basename "$cwd")
      mv "$f" "$base_memory/${fname%.*}-${wt_hint}.${fname##*.}"
    else
      mv "$f" "$base_memory/$fname"
    fi
  done

  rm -rf "$cwd_memory"
fi

# Create the symlink
mkdir -p "$cwd_project_dir"
ln -s "$base_memory" "$cwd_memory"
